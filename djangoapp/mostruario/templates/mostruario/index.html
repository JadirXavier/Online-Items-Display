{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Item List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="{% static 'mostruario/styles.css' %}" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital@0;1&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <script src="https://kit.fontawesome.com/cdac112bd6.js" crossorigin="anonymous"></script>
</head>

<body>
  {% include './navbar.html' %}
  <div class="container mt-5">
    <div class="filter-buttons mb-4 d-flex justify-content-center flex-wrap">
      <a href="?category=all&page={{ items.number }}" class="btn btn-outline-primary filter-button m-2 {% if category_filter == 'all' %}active-filter{% endif %}">
          <i class="fa-solid fa-house"></i> Todos
      </a>
      {% for category in categories %}
      <a href="?category={{ category.0 }}&page={{ items.number }}" class="btn btn-outline-primary filter-button m-2 {% if category_filter == category.0 %}active-filter{% endif %}">
          {% if category.0 == 'Artesanato' %}
          <i class="fa-solid fa-scissors"></i> Artesanato
          {% elif category.0 == 'Roupas' %}
          <i class="fa-solid fa-shirt"></i> Roupas
          {% elif category.0 == 'Bolsas' %}
          <i class="fa-solid fa-bag-shopping"></i> Bolsas
          {% endif %}
      </a>
      {% endfor %}
  </div>
    
    

    <!-- Grid -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4">
      {% for item in items %}
      <div class="col item" data-category="{{ item.category }}" data-id="{{ item.id }}">
        <div class="card h-100">
          {% if item.photo %}
          <img src="{{ item.photo.url }}" class="card-img-top" alt="{{ item.name }}" />
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ item.name }}</h5>
            <p class="card-text"><strong>Preço:</strong> R${{ item.price }}</p>
            {% if user.is_authenticated %}
            <!-- Botões -->
            <div class="button-group">
              <button class="btn btn-warning w-100 mb-2" onclick="toggleEditForm('{{ item.id }}')">Editar</button>
              <a href="{% url 'mostruario:delete_item' item.id %}" class="btn btn-danger w-100"
                onclick="return confirm('Tem certeza que deseja deletar este item?');">Deletar</a>
            </div>

            <!-- Formulário de Edição Escondido -->
            <div class="edit-form d-none mt-3">
              <form method="post" enctype="multipart/form-data" action="{% url 'mostruario:update_item' item.id %}">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary w-100">Salvar</button>
                <button type="button" class="btn btn-secondary w-100 mt-2"
                  onclick="toggleEditForm('{{ item.id }}')">Cancelar</button>
              </form>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}

      {% if user.is_authenticated %}
      <div class="col-6 col-md-4 col-lg-3 add-item">
        <!-- Botão de adicionar item -->
        <div class="card h-100 text-center" id="add-item-btn">
          <div class="card-body d-flex align-items-center justify-content-center">
            <h1>+</h1>
          </div>
        </div>

        <!-- Formulário de adição de item -->
        <div class="card h-100 d-none" id="add-item-form">
          <div class="card-body">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn btn-primary w-100">Adicionar item</button>
              <button type="button" class="btn btn-secondary w-100 mt-2" onclick="cancelAddItem()">Cancelar</button>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    <!-- Paginação -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mt-4">
        {% if items.has_previous %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ items.previous_page_number }}{% if category_filter != 'all' %}&category={{ category_filter }}{% endif %}"
            aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">&laquo;</span>
        </li>
        {% endif %}

        {% for num in items.paginator.page_range %}
        
        <li class="page-item {% if items.number == num %}active{% endif %}">
          <a class="page-link" href="?page={{ num }}{% if category_filter != 'all' %}&category={{ category_filter }}{% endif %}"> {{ num }} </a>
        </li>
        {% endfor %}

        {% if items.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?page={{ items.next_page_number }}{% if category_filter != 'all' %}&category={{ category_filter }}{% endif %}"
            aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        {% else %}
        <li class="page-item disabled">
          <span class="page-link">&raquo;</span>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <script>
    document.getElementById('add-item-btn').addEventListener('click', function () {
      document.getElementById('add-item-form').classList.remove('d-none'); // Mostra o formulário
      document.getElementById('add-item-btn').classList.add('d-none'); // Esconde o botão +
    });


    function cancelAddItem() {
      document.getElementById('add-item-form').classList.add('d-none'); // Esconde o formulário
      document.getElementById('add-item-btn').classList.remove('d-none'); // Mostra o botão +
    }

    function toggleEditForm(itemId) {
      console.log(itemId);

      var itemElement = document.querySelector('[data-id="' + itemId + '"]');

      if (itemElement) {
        var buttonGroup = itemElement.querySelector('.button-group');
        var editForm = itemElement.querySelector('.edit-form');

        if (editForm.classList.contains('d-none')) {
          editForm.classList.remove('d-none');
          buttonGroup.classList.add('d-none');
        } else {
          editForm.classList.add('d-none');
          buttonGroup.classList.remove('d-none');
        }
      }
    }

    function filterItems(category) {
      console.log('Filtrando por categoria:', category);

      let items = document.querySelectorAll('.item'); // Seleciona todos os itens
      let buttons = document.querySelectorAll('.filter-button'); // Seleciona todos os botões de filtro

      // Itera sobre os itens e ajusta sua visibilidade
      items.forEach(function (item) {
        let itemCategory = item.getAttribute('data-category'); // Obtém a categoria do item

        if (category === 'all' || itemCategory === category) {
          item.style.display = 'block'; // Exibe o item se ele pertence à categoria selecionada ou se "all" foi selecionado
        } else {
          item.style.display = 'none'; // Esconde o item se ele não pertence à categoria selecionada
        }
      });

      // Itera sobre os botões e remove a classe ativa
      buttons.forEach(function (button) {
        button.classList.remove('active-filter');
      });

      // Adiciona a classe ativa ao botão clicado
      document.querySelector(`button[onclick="filterItems('${category}')"]`).classList.add('active-filter');
    }
  </script>
</body>

</html>